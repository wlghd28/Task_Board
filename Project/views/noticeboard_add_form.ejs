<br>
<div>
    <section id="search-result-container" class="container">
        <form id=join name=join method=post enctype="multipart/form-data" action="/noticeboard/add" onsubmit="return check();">
            <h4>글 종류</h4>
            <select id="type" name="type">
                <option>공지사항</option>
                <option selected>일반</option>
            </select>
            <hr>
            <h4> 제목 </h4>
            <input type="text" style="width:100%" id="title" name="title">
            <hr>
            <h4>첨부파일</h4>
            <div class="notice_uploadfile">
                <p style="color:white;display:inline">첨부파일을 마우스로 끌어 넣으세요.</p>
                <a style="color:white;" id="uploadfile" onclick="jQuery('#files').click()" class="btn btn-primary">+내 PC</a>
            </div>
            <div class="insert">
                <input style="display:none;" type="file" id="files" name="files" onchange="addFile(this);" multiple="multiple" />
                <input type="hidden" id="filelist" name="filelist" value="" />
                <div id="file-list" name="file-list" class="file-list"></div>
                <!-- <div id="ckeditor-filelist" name="ckeditor-filelist"></div> -->
                
            </div>
            <hr>
            <textarea id="ckeditor" name="ckeditor"></textarea>
            <button style="float:right;margin:5px" class="btn btn-primary" type="button" onclick="location.href='/noticeboard/list/1'">취소</button>
            <button style="float:right;margin:5px" type="button" id="submit" class="btn btn-primary">등록</button>
        </form>
    </section>
</div>
<br>
<script>
    var theEditor;
    ClassicEditor
    // DecoupledEditor
    .create(document.querySelector('#ckeditor'), 
    {        
        // plugins:[],
        //removePlugins: [],
        // toolbar: 
        // [
        //     'Heading', 
        //     'Bold', 
        //     'Italic', 
        //     'BulletedList', 
        //     'NumberedList', 
        //     'BlockQuote', 
        //     'InsertTable', 
        //     'UploadImage',
        //     'Link',
        //     'toggleImageCaption',
        //     'imageTextAlternative',
        //     'Undo', 
        //     'Redo'
        // ],
        mediaEmbed: {
            previewsInData:true
        },
        language: 'ko',   
        ckfinder: 
        {     
            uploadUrl: '/noticeboard/ckeditor_upload'
        }
           
    })    
    .then(editor => {
        theEditor = editor;
        // ckeditor 값이 변할 때마다 호출
        // editor.model.document.on('change:data', function(e) {

        // });
    })
    .catch(error => {        
        alert(error);    
    });




    $('.notice_uploadfile')
        .on("dragover", dragOver)
        .on("dragleave", dragOver)
        .on("drop", uploadFiles);
 
    function dragOver(e){
        e.stopPropagation();
        e.preventDefault();
    }
    
    function uploadFiles(e){
        e.stopPropagation();
        e.preventDefault();
    }


    function dragOver(e) {
        e.stopPropagation();
        e.preventDefault();
        if (e.type == "dragover") {
            $(e.target).css({
                "background-color": "black",
                "outline-offset": "-20px"
            });
        } else {
            $(e.target).css({
                "background-color": "gray",
                "outline-offset": "-10px"
            });
        }
    }


    var maxFileCnt = 5;   // 첨부파일 최대 개수
    var fileNo = 0;
    var filesArr = new Array();

    function uploadFiles(e) {
        e.stopPropagation();
        e.preventDefault();
        dragOver(e); //1
    
        e.dataTransfer = e.originalEvent.dataTransfer; //2
        var files = e.target.files || e.dataTransfer.files;
    
        var attFileCnt = document.querySelectorAll('.filebox').length;    // 기존 추가된 첨부파일 개수
        var remainFileCnt = maxFileCnt - attFileCnt;    // 추가로 첨부가능한 개수
        var curFileCnt = files.length;  // 현재 선택된 첨부파일 개수

        // 첨부파일 개수 확인
        if (curFileCnt > remainFileCnt) {
            alert("첨부파일은 최대 " + maxFileCnt + "개 까지 첨부 가능합니다.");
        } else {
            for (const file of files) {
                // 첨부파일 검증
                if (validation(file)) {
                    // 파일 배열에 담기
                    var reader = new FileReader();
                    reader.onload = function () {
                        filesArr.push(file);
                    };
                    reader.readAsDataURL(file);

                    // 목록 추가
                    let htmlData = '';
                    htmlData += '<div id="file' + fileNo + '" class="filebox">';
                    htmlData += '   <p class="name">' + file.name + '</p>';
                    htmlData += '   <a class="delete" onclick="deleteFile(' + fileNo + ');"><i class="far fa-minus-square"></i></a>';
                    htmlData += '</div>';
                    htmlData += '<input type="hidden" id="filelist' + fileNo + '" name="filelist" value="'+ file.name + '">';
                    $('.file-list').append(htmlData);
                    fileNo++;
                } else {
                    // 초기화
                    //document.querySelector("input[type=file]").value = "";
                    //$('.file-list').empty();
                    continue;
                }
            }
        }
    }

    /* 첨부파일 추가 */
    function addFile(obj){
        var attFileCnt = document.querySelectorAll('.filebox').length;    // 기존 추가된 첨부파일 개수
        var remainFileCnt = maxFileCnt - attFileCnt;    // 추가로 첨부가능한 개수
        var curFileCnt = obj.files.length;  // 현재 선택된 첨부파일 개수
        var check = 0;

        // 첨부파일 개수 확인
        if (curFileCnt > remainFileCnt) {
            alert("첨부파일은 최대 " + maxFileCnt + "개 까지 첨부 가능합니다.");
        } else {
            for (const file of obj.files) {
                // 첨부파일 검증
                if (validation(file)) {
                    // 파일 배열에 담기
                    var reader = new FileReader();
                    reader.onload = function () {
                        filesArr.push(file);
                    };
                    reader.readAsDataURL(file);

                    // 목록 추가
                    let htmlData = '';
                    htmlData += '<div id="file' + fileNo + '" class="filebox">';
                    htmlData += '   <p class="name">' + file.name + '</p>';
                    htmlData += '   <a class="delete" onclick="deleteFile(' + fileNo + ');"><i class="far fa-minus-square"></i></a>';
                    htmlData += '</div>';
                    htmlData += '<input type="hidden" id="filelist' + fileNo + '" name="filelist" value="'+ file.name + '">';
                    $('.file-list').append(htmlData);
                    fileNo++;
                } else {
                    continue;
                }
            }
        }
    }

    /* 첨부파일 검증 */
    function validation(obj){
        const fileTypes = ['application/pdf', 'image/gif', 'image/jpeg', 'image/png', 'image/bmp', 'image/tif', 'application/haansofthwp', 'application/x-hwp'];
        if (obj.name.length > 100) {
            alert("파일명이 100자 이상인 파일은 업로드 할 수 없습니다.");
            return false;
        } else if (obj.size > (100 * 1024 * 1024)) {
            alert("최대 파일 용량인 100MB를 초과한 파일은 업로드 할 수 없습니다.");
            return false;
        } else if (obj.name.lastIndexOf('.') == -1) {
            alert("확장자가 없는 파일은 업로드 할 수 없습니다.");
            return false;
        } else if (!fileTypes.includes(obj.type)) {
            alert("첨부가 불가능한 파일이 포함됐습니다.");
            return false;
        } else {
            return true;
        }
    }

    /* 첨부파일 삭제 */
    function deleteFile(num) {
        document.querySelector("#file" + num).remove();
        document.querySelector("#filelist" + num).remove();
        filesArr[num].is_delete = true;
    }

    /* 폼 전송 */
    var noticeboard_check = 0;  // 0이면 등록 안 된 상태 1이면 등록 된 상태
    $("#submit").click(
        function submitForm(event) {
            if(!check()) return;
            //event.preventDefault();
            // 서버에 데이터를 넘기기 전에  기존에 들어있는 file 데이터 초기화
            document.querySelector("input[type=file]").value = "";
            // 폼데이터 담기
            var form = document.querySelector("form");
            var formData = new FormData(form);
            for (var i = 0; i < filesArr.length; i++) {
                // 삭제되지 않은 파일만 폼데이터에 담기
                if (!filesArr[i].is_delete) {
                    formData.append("files", filesArr[i]);
                }
            }

            // ckeditor 내용 삽입
            formData.append("content",theEditor.getData());


            $.ajax({
                method: 'POST',
                url: '/noticeboard/add',
                dataType: 'json',
                data: formData,
                processData: false,     // 이녀석 false로 해줘야 multipart 타입 가능하다.
                contentType: false,     // 이녀석 false로 해줘야 multipart 타입 가능하다.
                async: true,
                timeout: 30000,
                cache: false,
                headers: {'cache-control': 'no-cache', 'pragma': 'no-cache'},
                success: function () {
                    //alert("파일업로드 성공");
                    noticeboard_check = 1;
                    window.location.href = '/noticeboard/list/1';
                },
                error: function (xhr, desc, err) {
                    alert('에러가 발생 하였습니다.');
                    return;
                }
            })
        }
    );
    



    function check() {
        // // // 이미지 태그 쿼리 셀렉터 후 폼 데이터에 추가 (속성 이름 : ckfilelist)
        // var imgtag = document.querySelectorAll("img");
        // var htmlData = '';
        // if(imgtag)
        // {
        //     for(var i = 1; i < imgtag.length; i++)
        //     {

        //         htmlData += '<input type="hidden" id="ckeditorfilelist' + i + '" name="ckeditorfilelist" value="'+ imgtag[i].src + '">';
        //     }
        //     $('#ckeditor-filelist').append(htmlData);
        // }


        var title = document.getElementById('title').value;
        var content = theEditor.getData();

        if(!title)
        {
            alert("제목이 입력되지 않았습니다.");
            return false;
        }

        if(!content)
        {
            alert("내용이 입력되지 않았습니다.");
            return false;
        }

        return true;
    }



    $(window).on("beforeunload", function () {
        if(noticeboard_check == 0)
        {
            var message = "이 페이지에서 나가시겠습니까?\n\n지금까지 작성된 글은 저장되지 않습니다.";
            if (confirm(message)) return true;
            else return false;
        }
    });


</script>
